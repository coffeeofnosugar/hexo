---
title: 【Unity】行为树
date: 2024-07-05 15:32:06
tags:
  - Unity
---

<link rel="stylesheet" href="/../css/base.css">
<link rel="stylesheet" href="/../css/center.css">
<link rel="stylesheet" href="/../css/images.css">

花时间手撸了个行为树，现在通过做笔记的方式巩固一下学习的内容

总体来说，脚本 可以分为俩大类

- 为ScriptableObject（行为树）服务的脚本
- 为视图服务的Editor脚本

类图如下

<img class="half" src="/../images/unity/行为树/行为树类图.png"></img>

---

### 行为树脚本

控制人物行为的主要脚本，主要也可以分为两种

#### 行为树主干

 - `BehaviourTreeRunner`：挂载到实例上，选择行为树实例，运行行为树
 - `BehaviourTree`：控制行为树的行为。如：当根节点退出（即失败或成功）时结束整个行为树；创建、删除节点；添加、删除、获取子项，这些功能是为视图服务，在视图中调用这个方法就实现在更改视图的同时，更改ScriptableObject中的内容


#### 节点

 - `Node`：抽象类，一个进口，没有出口，**后面将采用(1,0)的方式表达**，所有节点都继承该类。存储一些数据：该实例节点当前状态、guid、该实例节点在视图中的位置坐标
 - `ActionNode`：抽象类**(1,0)**。特点是没有出口
 - `SequencerNode`：抽象类**(1,n)**。特点是多个出口
 - `DecoratorNode`：抽象类**(1,1)**。特点是一个出口
 - `RootNode`：根节点**(0,1)**。持续不断的运行子节点

以上的最基础的节点，其中`Node`是所有节点的父类。
`ActionNode`、`SequencerNode`、`DecoratorNode`都是抽象类，只是为了区分接口有多少个出口，没有其他特别的作用。
`RootNode`是根节点，所有行为树都必有的一个，后续一系列的运行将根节点开始。

如果有想要实现的节点都可以继承三大最基本的抽象类，即`ActionNode`、`SequencerNode`、`DecoratorNode`，如：

- `DebugLogNode`：继承`ActionNode`**(1,0)**，打印字符串
- `WaitNode`：继承`ActionNode`**(1,0)**，延时
- `SequencerNode`：继承`SequencerNode`**(1,n)**，定序器，将按照出口节点的顺序执行
- `RepeatNode`：继承`DecoratorNode`**(1,1)**，重复执行出口的节点

#### 小结

行为树脚本中，每个脚本并不是特别复杂。但是需要注意两点

- 类与类之间继承的很频繁，需要搞清楚他们之间的关系
- 在运行时脚本直接的跳转，这一点使用文字不是特别好表达，最好的办法还是启动unity在程序中执行一遍，大致的方向是`BehaviourTreeRunner`==>`BehaviourTree`==>`RootNode`==>根节点的子节点==>跟节点的子节点的子节点......，在程序运行时可以使用调试或者打印的方法查看程序运行的情况



---

### 视图脚本

将ScriptableObject中的内容展示到视图上，并且用户在操作视图中的内容时，ScriptableObject也会对应着改变

<font color="DarkGray">为了区分行为树中的节点与视图窗口中的节点，在本篇文章中我们将上面的行为树节点称为“节点”，将下方的视图脚本中的节点称为“节点元素”</font>

#### `BehaviourTreeEditor`行为树窗口

三个作用：

- `OpenWindow`、`CreateGUI`：创建一个窗口，用来显示行为树的视图
- `OnSelectionChange`方法：选择`Hierarchy`和`Project`中的行为树后，将行为树的内容展示到`BehaviourTreeView`视图中
- `OnNodeSelectionChanged`方法：选择`BehaviourTreeView`视图中的节点元素后，将该节点的`Inspector`窗口的内容映射到`BehaviourTreeEditor`行为树窗口左边的`InspectorView`视图中

#### `SplitView`

继承`TwoPaneSplitView`，将窗口分为两个可滑动的视图，<font color="DarkGray">创建完该脚本后会报错，在网络上查询后也并没有找到什么解决办法，只知道就是因为这个报错，所以官方才没有把这个基础的组件放在UI Builder中。但是不用管这个报错，这个报错只有在打开UI Builder的时候才会出现，而且也不影响使用</font>

#### `InspectorView`节点信息视图

摆放在行为树窗口的左侧，将选中的节点元素的`Inspector`窗口中的内容映射到该视图上

- `UpdateSelection`：显示当前选中的节点元素的Inspector内容

#### `BehaviourTreeView`行为树视图

行为树窗口的主体部分，将选中的ScriptableObject行为树内容展示到视图中，并且在该视图中对各个节点元素的操作也会更改到ScriptableObject中存储起来

- `BehaviourTreeView`：设置视图背景，为了达到透明网格的背景效果，可以直接复制uss中的代码；定义一些基础功能：使该视图可缩放、拖动、选择、方框选择

- `PopulateView`：将ScriptableObject中的内容显示到视图中，并注册委托：在视图中发生更改时执行`OnGraphViewChanged`方法

- `FindNodeView`：通过节点的guid查找与其对应的节点元素

- `GetCompatiblePorts`：重写父类方法。该方法能让视图中的节点相互连接，如果不写该方法将无法连接

- `OnGraphViewChanged`：在打开新的ScriptableObject时委托注册了该方法，该委托会在视图中有任何改变时调用该方法，功能如下

  - 因移除节点元素或连线而调用该方法时：同时删除ScriptableObject中对应的节点，以及该节点的父节点的child。

    > 值得注意的是`graphViewChange.elementsToRemove`返回的不仅是移除的节点元素(NodeView)，还有连线(Edge)

  - 因创建连线而调用该方法时：同时给ScriptableObject中对应的节点添加子节点

- `BuildContextualMenu`：重写父类方法。添加右键菜单功能

  > `var types = TypeCache.GetTypesDerivedFrom<ActionNode>()`返回的是`ActionNode`所有的派生类

- `CreateNode`：调用方法`BehaviourTree.CreateNode`创建节点`CreateNodeView`创建节点元素
- `CreateNodeView`：创建节点元素

#### `NodeView`节点元素

控制各个节点的基础信息

- `NodeView`、`CreateinputPorts`、`CreateOutputPorts`：创建节点元素时设置其标题、guid、位置、进口和出口的类型
- `SetPosition`：重写父类方法。在移动该节点元素后，将其新的位置信息存储到ScriptableObject节点中
- `OnSelected`：重写父类方法。定义一个委托，在窗口中选择该节点元素后，执行这个委托。<font color="DarkGray">每个节点元素在创建的时候就会注册这个委托了，但是注册这个委托的又是另外一个委托（我们称前一个委托为委托A，后一个委托为委托B），委托B是在创建行为树窗口时就注册了，注册实现的内容是：将该节点元素的节点Inspector信息映射到左侧的InspeView视图中。看起来比较绕，但其实就是为了保持代码的可维护性，没有让InspectorView的实例到出些，而为了让NodeView中的方法与BehaviourTreeEditor中的InspectorView实例联系起来而用了两个委托</font>



---

### 小结

这样就成功手撸出了一个简单的行为树了，还有可以增添一些小功能，比如新增选择节点、判断节点；右键创建节点元素时，让其生成在鼠标所在的位置；让每个节点元素展示不同的外观方便区分；时节点元素之间的连线律动起来，实时展示当前怪物的行为树进行到哪一步了

到目前为止，也只是实现了一个框架，我们最终的目的是要将这个行为树功能套用到怪物身上的，所以还并没有结束



[【Unity教程搬运】使用UI Builder、GraphView和脚本化对象创建行为树](https://www.bilibili.com/video/BV1Yg4y1M7VX/?spm_id_from=333.337.search-card.all.click&vd_source=56c4342823eb8458689563e7f2be4f99)
